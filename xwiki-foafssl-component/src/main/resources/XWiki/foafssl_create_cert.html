{{velocity}}
#set( $spkac = $request.spkac )
#set( $foafssl = $services.foafssl )
#set( $homepage = $xwiki.getDocument($context.user) )
#set( $addKey = true )


#if ( $request.getParameterMap().isEmpty())
 {{html clean="false"}}
 <form id="keygenform" action="" method="post">
  <table width="95%">
    <tr>
       <td>Common Name: </td>
       <td><input name="cn" size="30" id="cn" type="text" value="Xwiki Test Cert" /></td>
    </tr>
    <tr>
      <td>WebID: </td>
      <td><input name="webid" size="60" id="webid" type="text" value="${homepage.getExternalURL()}#me"/></td>
    </tr>
    <tr>
      <td>Key strength: </td>
      <td  id="keystrenghtd"><keygen id="spkac" name="spkac" challenge="TheChallenge1"/></td>
    </tr>
    <tr>
      <td>Valid for: <br/>
          (defaults to 1 year)</td>
      <td><input type="text" name="hours" value="0.0" size="4"/> hours<br/>
          <input type="text" name="days" value="0" size="4"/> days </td>
    </tr>
    <tr>
      <td>Debug: </td>
      <td><input type="checkbox" name="viewParams" value="yes" /> view parameters<br/>
          <input type="checkbox" name="showCert" value="yes" /> show  certificate<br/>
          <input type="checkbox" name="makeKeyObj" value="yes" /> create local objects<br/>
      </td>
    </tr>
    <tr>
       <td colspan="2">
         If none of the above debug options are checked then the following will happen on clicking submit:
        <ol>
            <li>your browser will create a public/private key pair</li>
            <li>send us your public key, in what is known as a <a href="http://en.wikipedia.org/wiki/Certification_request">certification request</a> along with information from the form above</li>
            <li>we will create a certificate with the parameters specified</li>
            <li>it will be returned to you and your browser will match it with your private key and add the pair to your keychain</li>
            <li>a <a href="$xwiki.getDocument('XWiki.foafssl_RSAPubKey').getURL('edit','editor=class')">foafssl_RSAPubKey</a> object will be created in <a href="$homepage">your public profile</a>, which you will then see clearly in  <a target="_blank" href="${homepage.getURL('edit','editor=object')}">its object view</a>. Your profile should also have an RDF view of the key.</li>
        </ol>
        </td>
  </tr>
  </table>
  <input id="keygensubmit" type="submit" value="submit certificate request" />
 </form>
<p>To test your certificates try some of <a href="http://esw.w3.org/topic/foaf+ssl">the foaf+ssl test pages</a>.</p>
 {{/html}}
#elseif($request.getParameter('viewParams') eq "yes")
  #foreach($key in $request.parameterNames)
     $key = $request.getParameter($key)
  #end
  #set( $addKey = false )
#end
#if( $spkac )
  #set( $cert = $foafssl.createFromSpkac( $request.spkac ) )
  #set( $pk = $cert.getSubjectPublicKey() )

  $cert.setSubjectWebID( $request.webid )
  $cert.setSubjectCommonName( $request.cn )

  #set ($hours = $request.getParameter('hours') )
  #if ($hours && $hours ne "")
     h = $hours
     $cert.addDurationInHours( $hours )
  #end

  #set ($days = $request.getParameter('days') )
  #if ($days && $days ne "")
     d=$days
     $cert.addDurationInDays( $days )
  #end

  #set($s = $cert.getSerialisation())

  #if( $request.getParameter('showCert') eq "yes")
   The certificate that would have been sent back to you is:
    mime-type: $s.getMimeType()
    Content-Length: $s.getLength()

    cert = $s.toString()
    #set( $addKey = false )
  #end
  #if ( $addKey ) ## up to here if addKey is still true, then we are creating a cert
    $s.writeTo( $response )
    $context.setFinished(true)
  #end

  #if ( $request.getParameter('makeKeyObj') eq "yes" )
   The Public Key, that will be stored on the server is:
    * hex= $pk.getHexModulus()
    * int= $pk.getIntExponent()
{{html}}More info in  <a target="_blank" href="${homepage.getURL('edit','editor=object')}">its object view</a>{{/html}}
    #set( $addKey = true )
  #end

  #if ( $addKey )
    ## create and save the public key to the user's profile page
    #set( $rsaKey = $homepage.newObject("XWiki.foafssl_RSAPubKey"))
    $!rsaKey.set("hexModulus", $pk.getHexModulus() )
    $!rsaKey.set("intExponent", $pk.getIntExponent() )
    $!rsaKey.set("name", $request.getParameter('cn') )
    $!rsaKey.set("validFrom", $cert.getStartDate() )
    $!rsaKey.set("validTo", $cert.getEndDate() )
    $!homepage.save()
  #end
#end

{{/velocity}}